<!DOCTYPE html>
<html>
<head>
  <title>Dashboard â€“ ProjectMap</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; padding: 20px; background: #f8f8f8; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    select, button { padding: 6px; }
    .delete-btn, .archive-btn { background: #c0392b; color: white; border: none; cursor: pointer; }
    .undo-btn { background: #2980b9; color: white; border: none; cursor: pointer; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>ðŸ—‚ Project Segment Dashboard</h2>
  <table id="segmentsTable">
    <thead>
      <tr>
        <th>Ticket Number</th>
        <th>Location</th>
        <th>Status</th>
        <th>Updated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="undoContainer" style="margin-top: 20px;"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, getDocs, updateDoc, deleteDoc, addDoc, doc, serverTimestamp, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBizMeB33zvk5Qr9JcE2AJNmx2sr8PnEyk",
      authDomain: "projectmap-35a69.firebaseapp.com",
      projectId: "projectmap-35a69",
      storageBucket: "projectmap-35a69.firebasestorage.app",
      messagingSenderId: "676439686152",
      appId: "1:676439686152:web:0fdc2d8aab41aec67fa5bd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tableBody = document.querySelector("#segmentsTable tbody");
    const undoContainer = document.getElementById("undoContainer");
    const segmentsRef = collection(db, "segments");
    const archiveRef = collection(db, "archived_segments");

    let lastDeleted = null;

    async function loadSegments() {
      const snapshot = await getDocs(segmentsRef);
      tableBody.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const row = document.createElement("tr");

        const ticketCell = document.createElement("td");
        ticketCell.textContent = data.ticketNumber || "";
        row.appendChild(ticketCell);

        const locationCell = document.createElement("td");
        locationCell.textContent = data.location || "";
        row.appendChild(locationCell);

        const statusCell = document.createElement("td");
        const select = document.createElement("select");
        ["Not Located", "In Progress", "Located"].forEach(status => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          if (data.status === status) option.selected = true;
          select.appendChild(option);
        });
        select.addEventListener("change", async () => {
          await updateDoc(doc(db, "segments", docSnap.id), {
            status: select.value,
            timestamp: serverTimestamp()
          });
          loadSegments();
        });
        statusCell.appendChild(select);
        row.appendChild(statusCell);

        const timeCell = document.createElement("td");
        const updated = data.timestamp?.toDate?.().toLocaleString?.() || "";
        timeCell.textContent = updated;
        row.appendChild(timeCell);

        const actionCell = document.createElement("td");

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = async () => {
          if (confirm("Are you sure you want to delete this segment?")) {
            lastDeleted = { id: docSnap.id, data };
            await deleteDoc(doc(db, "segments", docSnap.id));
            showUndo();
            loadSegments();
          }
        };
        actionCell.appendChild(deleteBtn);

        const archiveBtn = document.createElement("button");
        archiveBtn.textContent = "Archive";
        archiveBtn.className = "archive-btn";
        archiveBtn.style.marginLeft = "6px";
        archiveBtn.onclick = async () => {
          if (confirm("Archive this segment?")) {
            await setDoc(doc(archiveRef, docSnap.id), data);
            await deleteDoc(doc(db, "segments", docSnap.id));
            loadSegments();
          }
        };
        actionCell.appendChild(archiveBtn);

        row.appendChild(actionCell);
        tableBody.appendChild(row);
      });
    }

    function showUndo() {
      undoContainer.innerHTML = "";
      const msg = document.createElement("span");
      msg.textContent = "Segment deleted. ";
      const undoBtn = document.createElement("button");
      undoBtn.textContent = "Undo";
      undoBtn.className = "undo-btn";
      undoBtn.onclick = async () => {
        if (lastDeleted) {
          await setDoc(doc(db, "segments", lastDeleted.id), lastDeleted.data);
          lastDeleted = null;
          loadSegments();
          undoContainer.innerHTML = "";
        }
      };
      undoContainer.appendChild(msg);
      undoContainer.appendChild(undoBtn);
    }

    loadSegments();
  </script>
</body>
</html>
